DELIMITER $$
CREATE PROCEDURE insertAdKeyWord() 
BEGIN 
  
  DECLARE my_delimiter 		CHAR(1);
  DECLARE chat_statement 	VARCHAR(5000);
  DECLARE done         		INT;
  DECLARE occurance    		INT;
  DECLARE i            		INT;
  DECLARE split_id     		char(100);
  DECLARE ins_query    		VARCHAR(5000);
  
  DECLARE  	splitter_cur CURSOR FOR
  
  SELECT   	user_id, 
			Replace(chat,'''','') chat 
  FROM     	tbl_chathistory 
  ORDER 	BY chat_ts DESC limit 6;
  
  
  DECLARE CONTINUE handler FOR NOT found SET done=1;
  
  TRUNCATE TABLE `my_splits`;
  
  OPEN splitter_cur; 
  SPLITTER_LOOP:
  
  LOOP FETCH splitter_cur  
  INTO  split_id, chat_statement;
  	
	SET occurance = length(chat_statement) - length(replace(chat_statement,' ','')) +1;
	SET my_delimiter = ' ';
	IF done=1 then
	LEAVE SPLITTER_LOOP;
	END IF;


	IF occurance > 0 THEN
    SET i=1;
    WHILE i <= occurance DO
	
 
	INSERT INTO my_splits
            ( 
                        `splitted_column`, 
                        `id` 
            ) 
			
			
	SELECT 	Replace(Substring(Substring_index(chat_statement, ' ', i),
			Length(Substring_index(chat_statement, ' ', i -1)) + 1),' ', '') AS splitted_column,
			split_id;
			
	SET ins_query 	= concat("insert into my_splits(splitted_column,id) values(", concat("SUBSTRING_INDEX(SUBSTRING_INDEX('",chat_statement ,"', '",my_delimiter,"', ",i, "),'",my_delimiter,"',-1),",split_id,");"));
	SET @ins_query	= ins_query;

	PREPARE ins_query FROM @ins_query;
	EXECUTE Ins_query;
	SET i=i+1;
  END WHILE;


	ELSE 
		SET ins_query = concat("insert into my_splits(splitted_column,id) values(",chat_statement,"',",split_id,");");
		SET @ins_query=ins_query;
		PREPARE ins_query FROM @ins_query;
		EXECUTE Ins_query;ENDIF;
		SET occurance=0;
	END
	loop;

CLOSE splitter_cur;

	TRUNCATE TABLE tbl_finallist;

	INSERT INTO tbl_finallist 
				( 
							splitted_column, 
							id, 
							cnt 
				) 
	SELECT   Lower(splitted_column) AS splitted_column , 
			 id, 
			 Count(*) AS cnt 
	FROM     my_splits 
	WHERE    splitted_column IS NOT NULL 
	AND      splitted_column <> '' 
	AND      splitted_column NOT IN 
			 ( 
					SELECT wordslist 
					FROM   tbl_stopwordlist
			) 
	GROUP BY Lower(splitted_column), id 
	ORDER BY cnt DESC limit 1;

	INSERT INTO tbl_finallist 
				( 
							splitted_column, 
							id, 
							cnt 
				) 
	SELECT   Lower(splitted_column) AS splitted_column , 
			 'NFL', 
			 Count(*) AS cnt 
	FROM     my_splits 
	WHERE    splitted_column IS NOT NULL 
	AND      splitted_column <> '' 
	AND      splitted_column NOT IN 
			 ( 
					SELECT wordslist 
					FROM   tbl_stopwordlist
			) 
	GROUP BY Lower(splitted_column) 
	ORDER BY cnt DESC limit 1;

	TRUNCATE TABLE adtext;
	INSERT INTO adtext 
				( 
							linkurl, 
							add_ts 
				) 
	SELECT Concat(splitted_column, '>' , 'http://www.google.com/search?q=' , splitted_column ,'&btnI') , 
		   Sysdate() 
	FROM   tbl_finallist 
	WHERE  id='NFL' 
	AND    splitted_column IS NOT NULL;

	INSERT INTO adtext 
				( 
							linkurl, 
							add_ts 
				) 
	SELECT Concat(link,'>',hyperlink) , 
		   Sysdate() 
	FROM   tbl_adinventory s 
	JOIN   tbl_finallist c 
	ON     Find_in_set(Lower(s.keyword),Lower(c.splitted_column)) 
	WHERE  c.id='NFL' 

END $$ 

DELIMITER;